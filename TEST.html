<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 名古屋・北陸冬之旅</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>❄️</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f0f4f8; }
        .font-mono-display { font-family: 'Share Tech Mono', monospace; }
        .nav-item.active { color: #2563eb; transform: translateY(-2px); }
        .nav-indicator { position: absolute; top: 0; left: 0; width: 25%; height: 3px; background: #2563eb; transition: all 0.3s ease; }
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .hidden-item { display: none !important; }
        .timeline-line { position: absolute; left: 18px; top: 20px; bottom: -20px; width: 2px; background-color: #cbd5e1; z-index: 0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .flight-board { background-color: #1e293b; color: #e2e8f0; }
        .flight-row { border-bottom: 1px solid #334155; }
    </style>
</head>
<body class="text-slate-700 bg-slate-100 h-screen flex flex-col overflow-hidden">

    <header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-4 shadow-lg shrink-0 z-50 pt-safe-top">
        <div class="max-w-3xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-lg font-bold flex items-center"><span class="mr-2 text-xl">❄️</span> 2026 名古屋・北陸</h1>
                <p id="header-date" class="text-blue-100 text-xs mt-0.5 ml-8">載入中...</p>
            </div>
            <div class="text-right"><div class="bg-white/20 px-2 py-1 rounded text-xs"><i class="fa-solid fa-users mr-1"></i>Trip</div></div>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto no-scrollbar pb-24 relative" id="main-scroll">
        <div class="max-w-3xl mx-auto p-4 min-h-full">

            <div class="sticky top-0 z-40 bg-slate-100 pb-4 pt-1 mb-2">
                <div class="bg-white p-1 rounded-lg shadow-sm border border-slate-200 flex text-xs font-bold text-slate-500 overflow-x-auto no-scrollbar">
                    <button onclick="filterGroup('ALL')" class="filter-btn flex-1 py-1.5 px-3 rounded-md transition bg-slate-100 text-slate-800 shadow-sm whitespace-nowrap" id="btn-all">全員視角</button>
                    <button onclick="filterGroup('A')" class="filter-btn flex-1 py-1.5 px-3 rounded-md transition hover:bg-slate-50 whitespace-nowrap" id="btn-a"><span class="text-blue-600">暐傑與嘟嘟</span></button>
                    <button onclick="filterGroup('B')" class="filter-btn flex-1 py-1.5 px-3 rounded-md transition hover:bg-slate-50 whitespace-nowrap" id="btn-b"><span class="text-emerald-600">偉庭與明娟</span></button>
                    <button onclick="filterGroup('C')" class="filter-btn flex-1 py-1.5 px-3 rounded-md transition hover:bg-slate-50 whitespace-nowrap" id="btn-c"><span class="text-orange-500">梅玉與均穎</span></button>
                </div>
            </div>

            <div id="tab-itinerary" class="tab-content active space-y-6">
                <div id="loading-indicator" class="text-center py-10 text-slate-500"><i class="fa-solid fa-spinner fa-spin mr-2"></i> 正在同步雲端行程...</div>
            </div>

            <div id="tab-flights" class="tab-content space-y-4">
                 <div class="text-center text-slate-400 py-10">請貼回原本的航班 HTML 程式碼</div>
            </div>

            <div id="tab-hotels" class="tab-content space-y-4">
                <div class="text-center text-slate-400 py-10">請貼回原本的住宿 HTML 程式碼</div>
            </div>

            <div id="tab-info" class="tab-content space-y-4">
                <div class="bg-white rounded-2xl p-5 shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold flex items-center text-slate-800"><i class="fa-solid fa-cloud-sun mr-2 text-sky-500"></i> 旅程天氣預報</h2>
                    </div>
                    <div class="flex overflow-x-auto space-x-3 pb-2 no-scrollbar" id="weather-container">
                        </div>
                    <div class="mt-3 pt-3 border-t border-slate-100 flex justify-between items-end">
                        <div class="text-[10px] text-slate-400">JMA 模型整合</div>
                        <a href="https://www.jma.go.jp/bosai/forecast/" target="_blank" class="text-[10px] text-blue-500 bg-blue-50 px-2 py-1 rounded">JMA 官網</a>
                    </div>
                </div>

                <div class="bg-slate-800 text-white rounded-2xl p-5 shadow-lg">
                    <h2 class="text-lg font-bold mb-4 flex items-center"><i class="fa-solid fa-triangle-exclamation mr-2 text-yellow-400"></i> 重要備忘錄</h2>
                    <div class="space-y-4 text-sm" id="memo-container">
                        </div>
                </div>
            </div>

        </div>
    </main>

    <nav class="bg-white border-t border-slate-200 fixed bottom-0 w-full z-50 pb-safe">
        <div class="relative flex justify-around items-center h-16 max-w-3xl mx-auto">
            <div id="nav-indicator" class="nav-indicator"></div>
            <button onclick="switchTab('itinerary', 0)" class="nav-item active flex-1 flex flex-col items-center justify-center h-full text-slate-400"><i class="fa-solid fa-list-check text-xl mb-1"></i><span class="text-[10px] font-bold">行程</span></button>
            <button onclick="switchTab('flights', 1)" class="nav-item flex-1 flex flex-col items-center justify-center h-full text-slate-400"><i class="fa-solid fa-plane text-xl mb-1"></i><span class="text-[10px] font-bold">航班</span></button>
            <button onclick="switchTab('hotels', 2)" class="nav-item flex-1 flex flex-col items-center justify-center h-full text-slate-400"><i class="fa-solid fa-bed text-xl mb-1"></i><span class="text-[10px] font-bold">住宿</span></button>
            <button onclick="switchTab('info', 3)" class="nav-item flex-1 flex flex-col items-center justify-center h-full text-slate-400"><i class="fa-solid fa-suitcase text-xl mb-1"></i><span class="text-[10px] font-bold">準備</span></button>
        </div>
    </nav>

<script>
    // ============================================
    // 設定區
    // ============================================
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbwk_mdLI-MdJfERNoU2QMlXDluMDvMKSAz2jRuJSSZS4brkvxe-Oi-81qQN03hENzVMuQ/exec'; 

    let currentFilterGroup = 'ALL';
    let allData = []; // 儲存原始資料

    // 天氣資料庫 (包含所有日期)
    const weatherDb = [
        { date: '2026-02-12', label: '2/12', loc: 'Nagoya', name: '名古屋', lat: 35.18, long: 136.90, histCode: 1, temp: '1°~9°' },
        { date: '2026-02-13', label: '2/13', loc: 'Takayama', name: '高山', lat: 36.14, long: 137.25, histCode: 71, temp: '-5°~4°' },
        { date: '2026-02-14', label: '2/14', loc: 'Takayama', name: '新穗高', lat: 36.28, long: 137.57, histCode: 75, temp: '-8°~0°' },
        { date: '2026-02-15', label: '2/15', loc: 'Takayama', name: '合掌村', lat: 36.25, long: 136.90, histCode: 71, temp: '-6°~2°' },
        { date: '2026-02-16', label: '2/16', loc: 'Nagoya', name: '名古屋', lat: 35.18, long: 136.90, histCode: 2, temp: '1°~9°' },
        { date: '2026-02-17', label: '2/17', loc: 'Nagoya', name: '名古屋', lat: 35.18, long: 136.90, histCode: 1, temp: '2°~10°' },
        { date: '2026-02-18', label: '2/18', loc: 'Nagoya', name: '名古屋', lat: 35.18, long: 136.90, histCode: 1, temp: '2°~11°' },
        { date: '2026-02-19', label: '2/19', loc: 'Nagoya', name: '名古屋', lat: 35.18, long: 136.90, histCode: 1, temp: '3°~11°' },
        { date: '2026-02-20', label: '2/20', loc: 'Nagoya', name: '名古屋', lat: 35.18, long: 136.90, histCode: 2, temp: '2°~10°' },
        { date: '2026-02-21', label: '2/21', loc: 'Nagoya', name: '名古屋', lat: 35.18, long: 136.90, histCode: 3, temp: '2°~10°' }
    ];

    // 各組開始日期設定
    const groupStartDates = {
        'ALL': '2026-02-12',
        'A': '2026-02-12',
        'C': '2026-02-16',
        'B': '2026-02-17'
    };

    const weatherCodes = {
        0: { icon: "fa-sun", color: "text-orange-500" },
        1: { icon: "fa-cloud-sun", color: "text-orange-400" },
        2: { icon: "fa-cloud", color: "text-slate-400" },
        3: { icon: "fa-cloud", color: "text-slate-500" },
        71: { icon: "fa-snowflake", color: "text-sky-400" },
        75: { icon: "fa-snowflake", color: "text-sky-600" }
    };

    document.addEventListener('DOMContentLoaded', () => {
        fetchData();
        
        // 網址參數偵測
        const urlParams = new URLSearchParams(window.location.search);
        const userParam = urlParams.get('user');
        const userMap = { '暐傑': 'A', '偉庭': 'B', '梅玉': 'C' };
        if (userParam && userMap[userParam]) {
            filterGroup(userMap[userParam]);
        }
    });

    async function fetchData() {
        try {
            const response = await fetch(GAS_API_URL);
            allData = await response.json();
            
            // 分離資料：行程 vs 備忘錄
            const itineraryData = allData.filter(day => {
                // 這裡有點 trick，因為 GAS 回傳是按天分組的
                // 我們要檢查這一天的 items 裡面有沒有非 memo 的
                // 但簡單的做法是 render 時再過濾
                return true; 
            });

            renderItinerary(itineraryData);
            renderMemos(allData); // 傳入整包資料去撈備忘錄
            
            filterGroup(currentFilterGroup); // 初始化篩選
        } catch (error) {
            console.error(error);
            document.getElementById('loading-indicator').innerText = '載入失敗，請檢查網址或網路';
        }
    }

    // 渲染行程表
    function renderItinerary(days) {
        const container = document.getElementById('tab-itinerary');
        container.innerHTML = ''; 

        days.forEach(day => {
            // 過濾掉 Type 是 memo 的項目，不顯示在行程表
            const items = day.items.filter(i => i.Type !== 'memo');
            if(items.length === 0) return; // 如果這天只有備忘錄，行程表不顯示這天

            // 時間排序
            items.sort((a, b) => (a.Time || '99:99').localeCompare(b.Time || '99:99'));

            let allGroups = new Set();
            items.forEach(item => {
                if(item.Group) item.Group.split(',').forEach(g => allGroups.add(g.trim()));
            });
            const groupAttr = Array.from(allGroups).join(',');

            // 圓點顏色
            let dotColor = 'bg-slate-700';
            if (groupAttr.includes('A')) dotColor = 'bg-blue-500';
            if (groupAttr.includes('B')) dotColor = 'bg-emerald-500';
            if (groupAttr.includes('C')) dotColor = 'bg-orange-500';
            if (groupAttr.includes('A') && groupAttr.includes('B')) dotColor = 'bg-green-600'; 
            if (groupAttr.includes('ALL')) dotColor = 'bg-purple-600';

            const dayHtml = `
            <div class="relative pl-8 day-container multi-group" data-groups="${groupAttr}" data-date="${day.date}">
                <div class="timeline-line"></div>
                <div class="timeline-dot absolute left-0 top-1 w-10 h-10 ${dotColor} text-white rounded-full flex items-center justify-center font-bold shadow-md z-10">D?</div>
                
                <div class="bg-white rounded-xl p-4 shadow-sm ml-4 border-l-4 ${dotColor.replace('bg-', 'border-')}">
                    <div class="flex justify-between items-baseline mb-2">
                        <h3 class="font-bold text-lg">${day.date}</h3>
                    </div>
                    <div class="space-y-3">
                        ${items.map(item => renderItem(item)).join('')}
                    </div>
                </div>
            </div>`;
            container.insertAdjacentHTML('beforeend', dayHtml);
        });
    }

    // 渲染單項
    function renderItem(item) {
        const nameMap = { 'A': '暐傑與嘟嘟', 'B': '偉庭與明娟', 'C': '梅玉與均穎', 'ALL': '全員' };
        
        let groupBadge = '';
        const rawGroup = item.Group;
        if(rawGroup && rawGroup !== 'ALL') {
            let badgeClass = 'bg-slate-100 text-slate-600';
            if(rawGroup.includes('A')) badgeClass = 'bg-blue-50 text-blue-600';
            if(rawGroup.includes('B')) badgeClass = 'bg-emerald-50 text-emerald-600';
            if(rawGroup.includes('C')) badgeClass = 'bg-orange-50 text-orange-600';
            let displayName = nameMap[rawGroup] || rawGroup;
            groupBadge = `<span class="text-[10px] px-1.5 py-0.5 rounded font-bold mr-2 ${badgeClass} whitespace-nowrap">${displayName}</span>`;
        }

        if (item.Type === 'transport' || item.Type === 'bus' || item.Type === 'flight') {
            const themeColor = item.Type === 'bus' ? 'amber' : 'slate';
            return `
            <div class="bg-${themeColor}-50 border border-${themeColor}-200 rounded-lg p-2.5 text-sm shadow-sm filterable-item" data-groups="${item.Group}">
                <div class="flex justify-between items-center border-b border-${themeColor}-200 pb-1.5 mb-1.5">
                    <span class="font-bold text-${themeColor}-800 flex items-center"><i class="fa-solid fa-${item.Icon} mr-1.5 text-${themeColor}-500"></i>${item.Title}</span>
                    ${item.Subtitle ? `<span class="text-[10px] font-mono text-${themeColor}-700 bg-white px-1 rounded border border-${themeColor}-100">${item.Subtitle}</span>` : ''}
                </div>
                <div class="flex justify-between items-center">
                    <div></div>
                    <div class="text-right flex items-center w-full justify-end">${groupBadge}${item.Note ? `<span class="text-xs text-${themeColor}-600 font-bold bg-white px-1.5 py-0.5 rounded border border-${themeColor}-100 ml-1">${item.Note}</span>` : ''}</div>
                </div>
            </div>`;
        }
        if (item.Type === 'remark') {
            return `<div class="bg-red-50 text-red-600 text-xs p-2 rounded border border-red-100 leading-tight filterable-item flex items-start" data-groups="${item.Group}"><i class="fa-solid fa-triangle-exclamation mr-1.5 mt-0.5"></i><div><span class="font-bold">${item.Title}</span> ${item.Note || ''}</div></div>`;
        }
        let iconColor = 'text-slate-400';
        if(item.Type === 'food') iconColor = 'text-red-400';
        if(item.Type === 'event') iconColor = 'text-purple-500';
        if(item.Type === 'hotel') iconColor = 'text-blue-400';
        return `
        <div class="flex items-start filterable-item" data-groups="${item.Group}">
            <div class="mt-1 mr-2 w-5 text-center"><i class="fa-solid fa-${item.Icon} ${iconColor}"></i></div>
            <div class="flex-1">
                <div class="flex flex-wrap items-center">${groupBadge}<span class="text-sm text-slate-700 font-medium ${item.Type === 'event' ? 'font-bold text-purple-700' : ''}">${item.Title}</span></div>
                ${item.Note ? `<div class="text-xs text-slate-500 mt-0.5 pl-1">${item.Note}</div>` : ''}
            </div>
        </div>`;
    }

    // 渲染備忘錄 (從 Sheet 讀取 Type=memo)
    function renderMemos(allDays) {
        const container = document.getElementById('memo-container');
        container.innerHTML = '';
        
        let hasMemo = false;
        allDays.forEach(day => {
            day.items.forEach(item => {
                if (item.Type === 'memo') {
                    hasMemo = true;
                    const html = `
                    <div class="flex items-start filterable-item multi-group" data-groups="${item.Group}">
                        <div class="bg-white/10 p-2 rounded mr-3 shrink-0"><i class="fa-solid fa-${item.Icon || 'circle-info'} text-emerald-300"></i></div>
                        <div>
                            <div class="font-bold text-emerald-200">${item.Title}</div>
                            <p class="opacity-80 text-xs mt-1">${item.Note || ''}</p>
                        </div>
                    </div>`;
                    container.insertAdjacentHTML('beforeend', html);
                }
            });
        });

        if (!hasMemo) container.innerHTML = '<div class="text-center opacity-50">暫無備忘錄</div>';
    }

    // 渲染天氣 (根據組別過濾日期)
    function renderWeather(group) {
        const container = document.getElementById('weather-container');
        container.innerHTML = '';
        
        const startDate = groupStartDates[group];
        // 過濾出該組別開始日期之後的天氣
        const filteredWeather = weatherDb.filter(w => w.date >= startDate);

        // 用來計算該組別的第幾天 (D1, D2...)
        let dayCount = 1;

        filteredWeather.forEach(w => {
            const info = weatherCodes[w.histCode] || weatherCodes[2];
            const borderColor = w.loc === 'Takayama' ? 'border-blue-200 bg-blue-50' : 'border-orange-100 bg-orange-50';
            
            const card = `
            <div class="flex-none w-28 p-3 rounded-xl border ${borderColor} flex flex-col items-center justify-between snap-center">
                <div class="text-xs font-bold text-slate-500">${w.label} <span class="opacity-50">(D${dayCount})</span></div>
                <div class="font-bold text-sm text-slate-700 my-1">${w.name}</div>
                <div class="text-2xl ${info.color} my-1"><i class="fa-solid ${info.icon}"></i></div>
                <div class="text-xs font-medium text-slate-600">${w.temp}</div>
            </div>`;
            container.insertAdjacentHTML('beforeend', card);
            dayCount++;
        });
    }

    // 主篩選功能
    function filterGroup(group) {
        currentFilterGroup = group;
        
        // 1. 更新按鈕
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('bg-slate-100', 'shadow-sm', 'text-slate-800');
            btn.classList.add('text-slate-500', 'hover:bg-slate-50');
        });
        const activeBtn = document.getElementById('btn-' + group.toLowerCase());
        if(activeBtn) {
            activeBtn.classList.add('bg-slate-100', 'shadow-sm', 'text-slate-800');
            activeBtn.classList.remove('text-slate-500', 'hover:bg-slate-50');
        }

        // 2. 更新 Header 文字
        const headerText = {
            'ALL': '2/12 (四) ~ 2/21 (六)｜共 10 天',
            'A': '2/12 (四) ~ 2/21 (六)｜暐傑與嘟嘟',
            'B': '2/17 (二) ~ 2/21 (六)｜偉庭與明娟',
            'C': '2/16 (一) ~ 2/21 (六)｜梅玉與均穎'
        };
        document.getElementById('header-date').innerText = headerText[group] || 'Trip';

        // 3. 篩選行程項目
        const items = document.querySelectorAll('.filterable-item');
        items.forEach(item => {
            const itemGroup = item.getAttribute('data-group'); // 舊版相容
            const multiGroups = item.getAttribute('data-groups'); // 主要判斷依據
            
            let isVisible = false;
            if (group === 'ALL') {
                isVisible = true;
            } else {
                if (itemGroup === 'ALL' || (multiGroups && multiGroups.includes('ALL'))) isVisible = true;
                else if (itemGroup === group) isVisible = true;
                else if (multiGroups && multiGroups.includes(group)) isVisible = true;
            }

            if (isVisible) item.classList.remove('hidden-item');
            else item.classList.add('hidden-item');
        });

        // 4. 處理天數容器 (如果該天沒有任何可見行程，隱藏整天)
        // 同時重算 D1, D2...
        const dayContainers = document.querySelectorAll('.day-container');
        let dayIndex = 1;

        dayContainers.forEach(day => {
            // 檢查這一天裡面有沒有「非 hidden」的 item
            const visibleItems = day.querySelectorAll('.filterable-item:not(.hidden-item)');
            
            if (visibleItems.length > 0) {
                day.classList.remove('hidden-item');
                // 更新該天的圓點數字
                const dot = day.querySelector('.timeline-dot');
                if (dot) dot.innerText = `D${dayIndex}`;
                dayIndex++;
            } else {
                day.classList.add('hidden-item');
            }
        });

        // 5. 更新天氣卡片 (傳入 group 讓它重畫)
        renderWeather(group);
    }

    function switchTab(tabId, index) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById(`tab-${tabId}`).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item')[index].classList.add('active');
        document.getElementById('nav-indicator').style.left = `${index * 25}%`;
        document.getElementById('main-scroll').scrollTop = 0;
    }
</script>
</body>
</html>
